#!/bin/bash

# WORKING ON THIS SCRIPT :
Creating_SFile

curl -o Demo.sh https://raw.githubusercontent.com/Bibhuti1221Bhushan/Installer/Global/Demo.sh

# INTEL
mesa 
lib32-mesa 
vulkan-intel
lib32-vulkan-intel
libva-intel-driver 
lib32-libva-intel-driver
libva-utils 
libvdpau-va-gl 

# AMD
mesa lib32-mesa mesa-vdpau lib32-mesa-vdpau libva-mesa-driver lib32-libva-mesa-driver xf86-video-amdgpu 

# ATI
mesa 
lib32-mesa 
mesa-vdpau 
lib32-mesa-vdpau 
libva-mesa-driver
lib32-libva-mesa-driver
xf86-video-ati


# ENABLE SERVICES :
arch-chroot /mnt systemctl enable systemd-timesyncd.service &>> $LOGFILE
arch-chroot /mnt systemctl enable fstrim.timer &>> $LOGFILE
arch-chroot /mnt systemctl enable paccache.timer &>> $LOGFILE
arch-chroot /mnt systemctl enable reflector.timer &>> $LOGFILE
arch-chroot /mnt systemctl enable systemd-boot-update.service &>> $LOGFILE

# INSTALLING PACMAN KEYS :
rm -rf /etc/pacman.d/gnupg
pacman-key --init
pacman-key --populate
pacman -Sy --noconfirm --disable-download-timeout archlinux-keyring

# SET GRAPHICS DRIVER :
# ~~~~~~~~~~~~~~~~~~~~~
Setting_Graphics () {
    Spin 15 SETTING &
    PID=$!
    if
        GPU=$(lspci)
        if grep -E "NVIDIA|GeForce" <<< ${GPU}; then
            arch-chroot /mnt pacman -S --noconfirm nvidia nvidia-utils &>> $LOGFILE
        elif lspci | grep 'VGA' | grep -E "Radeon|AMD"; then
            arch-chroot /mnt pacman -S --noconfirm mesa lib32-mesa mesa-vdpau lib32-mesa-vdpau libva-mesa-driver lib32-libva-mesa-driver xf86-video-amdgpu &>> $LOGFILE
        elif grep -E "Integrated Graphics Controller" <<< ${GPU}; then
            arch-chroot /mnt pacman -S --noconfirm mesa lib32-mesa vulkan-intel lib32-vulkan-intel libva-intel-driver lib32-libva-intel-driver libva-utils libvdpau-va-gl &>> $LOGFILE
        elif grep -E "Intel Corporation UHD" <<< ${GPU}; then
            arch-chroot /mnt pacman -S --noconfirm mesa lib32-mesa vulkan-intel lib32-vulkan-intel libva-intel-driver lib32-libva-intel-driver libva-utils libvdpau-va-gl &>> $LOGFILE
        fi
    then
        sleep 1
        kill $PID
        Done_Print "SETTING GRAPHICS DRIVER."
    else
        kill $PID
        Warn_Print "SETTING GRAPHICS DRIVER."
        exit 1
    fi
}

Info_Print "SETTING GRAPHICS DRIVER."
Setting_Graphics
echo "" &>> $LOGFILE

# SET VM GUEST TOOLS :
# ~~~~~~~~~~~~~~~~~~~~
Setting_VMTools () {
    Spin 14 SETTING &
    PID=$!
    if
        VM=$(systemd-detect-virt)
        if [[ $VM == kvm ]]; then
            arch-chroot /mnt pacman -S --noconfirm qemu-guest-agent &>> $LOGFILE
            arch-chroot /mnt systemctl enable qemu-guest-agent &>> $LOGFILE
        elif [[ $VM == vmware ]]; then
            arch-chroot /mnt pacman -S --noconfirm open-vm-tools &>> $LOGFILE
            arch-chroot /mnt systemctl enable vmtoolsd &>> $LOGFILE
            arch-chroot /mnt systemctl enable vmware-vmblock-fuse &>> $LOGFILE
        elif [[ $VM == oracle ]]; then
            arch-chroot /mnt pacman -S --noconfirm virtualbox-guest-utils &>> $LOGFILE
            arch-chroot /mnt systemctl enable vboxservice &>> $LOGFILE
        elif [[ $VM == microsoft ]]; then
            arch-chroot /mnt pacman -S --noconfirm hyperv &>> $LOGFILE
            arch-chroot /mnt systemctl enable hv_fcopy_daemon &>> $LOGFILE
            arch-chroot /mnt systemctl enable hv_kvp_daemon &>> $LOGFILE
            arch-chroot /mnt systemctl enable hv_vss_daemon &>> $LOGFILE
        fi
    then
        sleep 1
        kill $PID
        Done_Print "SETTING VM GUEST TOOLS."
    else
        kill $PID
        Warn_Print "SETTING VM GUEST TOOLS."
        exit 1
    fi
}

if [[ "$VM" = "none" ]]; then
else
    Info_Print "SETTING VM GUEST TOOLS."
    Setting_VMTools
    echo
fi

# SET PLYMOUTH BOOT SPLASH :
# ~~~~~~~~~~~~~~~~~~~~~~~~~~
Info_Print "SETTING PLYMOUTH BOOT SPLASH."
pacman -S --noconfirm plymouth
git clone
Done_Print "SETTING PLYMOUTH BOOT SPLASH."
echo




# Configuring /etc/mkinitcpio.conf.
info_print "Configuring /etc/mkinitcpio.conf."
cat > /mnt/etc/mkinitcpio.conf <<EOF
HOOKS=(systemd autodetect keyboard sd-vconsole modconf block sd-encrypt filesystems)
EOF

# ZRAM configuration.
info_print "Configuring ZRAM."
cat > /mnt/etc/systemd/zram-generator.conf <<EOF
[zram0]
zram-size = min(ram, 8192)
EOF


# Boot backup hook.
info_print "Configuring /boot backup when pacman transactions are made."
mkdir /mnt/etc/pacman.d/hooks
cat > /mnt/etc/pacman.d/hooks/50-bootbackup.hook <<EOF
[Trigger]
Operation = Upgrade
Operation = Install
Operation = Remove
Type = Path
Target = usr/lib/modules/*/vmlinuz

[Action]
Depends = rsync
Description = Backing up /boot...
When = PostTransaction
Exec = /usr/bin/rsync -a --delete /boot /.bootbackup
EOF

sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="[^"]*/& splash /' /etc/default/grub

# -------------------------------------------------------------------------
#               Enabling (and Theming) Plymouth Boot Splash
# -------------------------------------------------------------------------

PLYMOUTH_THEMES_DIR="$HOME/ArchTitus/configs/usr/share/plymouth/themes"
PLYMOUTH_THEME="arch-glow" # can grab from config later if we allow selection
mkdir -p /usr/share/plymouth/themes
echo 'Installing Plymouth theme...'
cp -rf ${PLYMOUTH_THEMES_DIR}/${PLYMOUTH_THEME} /usr/share/plymouth/themes
if  [[ $FS == "luks"]]; then
  sed -i 's/HOOKS=(base udev*/& plymouth/' /etc/mkinitcpio.conf # add plymouth after base udev
  sed -i 's/HOOKS=(base udev \(.*block\) /&plymouth-/' /etc/mkinitcpio.conf # create plymouth-encrypt after block hook
else
  sed -i 's/HOOKS=(base udev*/& plymouth/' /etc/mkinitcpio.conf # add plymouth after base udev
fi
plymouth-set-default-theme -R arch-glow # sets the theme and runs mkinitcpio
echo 'Plymouth theme installed'





    # Intel/AMD/NVIDIA drivers are not installed on virtual machines
    if [ "$hypervisor" = "none" ]; then

          if grep -Fq "$gpu_pci_id" "$DIR"/etc/nvidia_390_pci_ids; then
            DESKTOP_PACKAGES+=('nvidia-390xx' 'nvidia-390xx-utils' 'nvidia-390xx-settings')
          elif grep -Fq "$gpu_pci_id" "$DIR"/etc/nvidia_340_pci_ids; then

            DESKTOP_PACKAGES+=('xf86-video-nouveau' 'mesa')
          else
            DESKTOP_PACKAGES+=('nvidia' 'nvidia-utils' 'nvidia-settings')
          fi
        else
          DESKTOP_PACKAGES+=('xf86-video-nouveau' 'mesa')
        fi
      elif lspci | grep "VGA" | grep -q "ATI\|AMD"; then

"ATI" "Open-source ATI/AMD Radeon driver" \
"AMDGPU" "Open-source driver for the latest AMD GPUs" \
"None" "-" 3>&1 1>&2 2>&3)
        if [ "$gpu_driver" = "ATI" ]; then
          DESKTOP_PACKAGES+=('xf86-video-ati' 'mesa')
        else
          DESKTOP_PACKAGES+=('xf86-video-amdgpu' 'mesa')
        fi
      fi
    else
      dialog --title "Virtual Machine Detected" \
        --msgbox "The installer has detected a virtualized environment: \
$hypervisor\n\nAny required drivers or utilities will be \
installed for you." 7 70
      case "$hypervisor" in
        "vmware") DESKTOP_PACKAGES+=('open-vm-tools' 'xf86-video-vmware' 'xf86-input-vmmouse' 'mesa' 'gtkmm' 'gtkmm3') ;;
        "oracle") DESKTOP_PACKAGES+=('virtualbox-guest-utils' 'virtualbox-guest-dkms') ;;
        "parallels") DESKTOP_PACKAGES+=('xf86-video-vesa') ;;
        *) DESKTOP_PACKAGES+=('xf86-video-fbdev') ;;
      esac
    fi
  fi
}

# GPU-related globals
GPU_CHIPSET='Unknown'
DEFAULT_GPU_DRIVER='xf86-video-vesa'
NVIDIA_GPU_PACKAGES='
  nvidia-prime
  nvidia-settings
  nvidia-utils lib32-nvidia-utils
  nvtop
'
AMD_GPU_PACKAGES='
  vulkan-radeon lib32-vulkan-radeon
'




if [ "$hypervisor" != "none" ]; then
    if [ "$hypervisor" = "oracle" ]; then
      dialog --infobox "Enabling VirtualBox modules..." 3 50
      arch-chroot /mnt systemctl enable vboxservice.service &> /dev/null
    elif [ "$hypervisor" = "vmware" ]; then
      dialog --infobox "Enabling VMware Open-VM-Tools..." 3 50
      arch-chroot /mnt systemctl enable vmtoolsd.service &> /dev/null
      arch-chroot /mnt systemctl enable vmware-vmblock-fuse.service &> /dev/null
    fi
  fi
}






BASE_PACKAGES='
  acpi
  alsa-utils
  arch-wiki-lite
  asciiquarium
  audacious
  base-devel
  bash-completion
  breeze
  cmatrix
  cool-retro-term
  cowsay
  cpupower
  cups-pdf
  dialog
  dictd
  duf
  foliate
  fortune-mod
  figlet
  fwupd
  gamemode lib32-gamemode
  git-lfs
  gnu-netcat
  grub
  gst-libav
  gst-plugins-base
  gst-plugins-good
  gst-plugins-bad
  gst-plugins-ugly
  gufw
  gvfs-mtp
  gvfs-smb
  gvim
  hplip
  inetutils
  iputils
  jp2a
  kernel-modules-hook
  libreoffice-fresh
  licenses
  linux
  linux-firmware
  linux-headers
  lolcat
  man-db
  man-pages
  mesa lib32-mesa
  mlocate
  neofetch
  networkmanager
  noto-fonts-emoji
  nss-mdns
  p7zip
  pacman-contrib
  pavucontrol
  pipewire
  ps_mem
  pulseaudio-alsa
  pulseaudio-bluetooth
  reflector
  screenfetch
  sl
  soundfont-fluid
  systemd-sysvcompat
  tree
  ttf-dejavu
  ttf-liberation
  unrar
  unzip
  vi
  wget
  wtf
  xchm
  xclip
  xdg-user-dirs
  xorg-apps
  xorg-server
  xorg-xinit
  zip


# Needed
# Utils
wget
curl
tree
grep
ripgrep
openssh
sshfs
tldr
aha
make
cmake
automake
autoconf
bash-completion
htop
stow
neofetch
lsb-release
v4l2loopback-dkms
v4l2loopback-utils
# Tools
tmux
net-tools
npm
ninja
flatpak
# Editors
nano
neovim
# Other file systems
dosfstools
exfat-utils
ntfs-3g
mtpfs
gvfs-mtp
# Archive tools
unrar
unzip
zip
gzip
bzip2
# 'New' tools
lsd
btop
bat
# Fun
cmatrix
figlet
cowsay
# File explorer
vifm




if yesno "${TOUCHPAD_MSG}" "${YES}" "${NO}" --defaultno; then
    BASE_PACKAGES+='xf86-input-libinput '
    log "* Added touchpad support"
  fi
  if yesno "${OS_PROBER_MSG}" "${YES}" "${NO}" --defaultno; then
    BASE_PACKAGES+='os-prober '
    log "* Added OS prober"
  fi
  if "${UEFI}"; then
    BASE_PACKAGES+='efibootmgr '
    log "* Added EFI boot manager"
  fi
  if "${BTRFS_ROOT}"; then
    BASE_PACKAGES+='grub-btrfs '
    log "* Added GRUB Btrfs snapshot support"
  fi



QEMU = spice-vdagent qemu-guest-agent
VMWARE = xf86-video-vmware xf86-input-vmmouse 



# GRUB config
  mkdir -p /mnt"${grub_theme}"
  cp -rT "${extra}"/grub /mnt"${grub_theme}"
  if mount | grep -q ' /mnt/boot type [^b]' ||
      (! mount | grep -q ' /mnt/boot ' && ! "${BTRFS_ROOT}"); then
    sed -i 's/GRUB_DEFAULT=0/GRUB_DEFAULT=saved/' "${grub}"
    sed -i 's/#GRUB_SAVEDEFAULT/GRUB_SAVEDEFAULT/' "${grub}"
  fi
  sed -i 's/GRUB_TIMEOUT=5/GRUB_TIMEOUT=3/' "${grub}"
  sed -i "s/GRUB_GFXM.*/GRUB_GFXMODE=1920x1080,1366x768,auto/" "${grub}"
  sed -i "s:#GRUB_COLOR_N.*:GRUB_COLOR_NORMAL=\"red/black\":" "${grub}"
  sed -i "s:#GRUB_COLOR_H.*:GRUB_COLOR_HIGHLIGHT=\"yellow/black\":" "${grub}"
  sed -i "s:#GRUB_THEME.*:GRUB_THEME=\"${grub_theme}/theme.txt\":" "${grub}"
  if "${SYSTEM_AUTO_ENCRYPTED}"; then
    sed -i "s!quiet!cryptdevice=/dev/lvm/lvroot:root:allow-discards \
root=/dev/mapper/root transparent_hugepage=never!" "${grub}"
  else
    sed -i 's/quiet/transparent_hugepage=never/' "${grub}"
  fi
  if grep -q 'nvidia' <<<"${BASE_PACKAGES}"; then
    sed -i '/GRUB_CMDLINE_LINUX_DEFAULT=/s/.$/ nvidia-drm.modeset=1"/;s/" /"/' \
      "${grub}"



echo -e "Section \"InputClass\"\nIdentifier \"system-keyboard\"\n\
MatchIsKeyboard \"on\"\nOption \"XkbLayout\" \"${KEYMAP}\"\nEndSection" \
    >/mnt/etc/X11/xorg.conf.d/00-keyboard.conf

if [[ "${DESKTOP_ENV}" == 'kde-plasma' ]]; then
    mkdir /mnt/etc/sddm.conf.d
    echo -e "[Autologin]\nRelogin=false\nSession=\nUser=\n\n[General]\n\
HaltCommand=/usr/bin/systemctl poweroff\nRebootCommand=/usr/bin/systemctl \
reboot\n\n[Theme]\nCurrent=breeze\n\n[Users]\nMaximumUid=60513\n\
MinimumUid=1000" >/mnt/etc/sddm.conf.d/kde_settings.conf



  cp /mnt/etc/skel/.face /mnt/var/lib/AccountsService/icons/"${USERNAME}"
  echo -e "[User]\nIcon=/var/lib/AccountsService/icons/${USERNAME}
SystemAccount=false" >/mnt/var/lib/AccountsService/users/"${USERNAME}"

  log "User added: ${USERNAME}"
}


# Remove no password sudo rights
sed -i 's/^%wheel ALL=(ALL) NOPASSWD: ALL/# %wheel ALL=(ALL) NOPASSWD: ALL/' /etc/sudoers
sed -i 's/^%wheel ALL=(ALL:ALL) NOPASSWD: ALL/# %wheel ALL=(ALL:ALL) NOPASSWD: ALL/' /etc/sudoers
# Add sudo rights
sed -i 's/^# %wheel ALL=(ALL) ALL/%wheel ALL=(ALL) ALL/' /etc/sudoers
sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers












































# PACKAGES
blueman
bluez
bluez-utils

swaync  
galculator
sublime text 4
ms vscode 
evince
mpv
imv + restro
gnome-disk-utility



Arc Theme
Brave





